<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>الدفع — MERAC</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{
      --bg-left:#071224; --bg-mid:#071827; --bg-right:#00101a;
      --accent:#38bdf8; --muted:#b8d6e6;
      --glass-border: rgba(255,255,255,0.08);
      --card-bg: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      --success: #22c55e; --warn: #f59e0b; --danger: #ef4444;
    }
    html,body{height:100%;margin:0;font-family: "Poppins", "Segoe UI", sans-serif;background: linear-gradient(120deg,var(--bg-left),var(--bg-mid) 50%,var(--bg-right));color:#e8f6ff;}
    .topbar{position:sticky; top:0; z-index:60;backdrop-filter: blur(12px);background: rgba(2,12,20,0.45);border-bottom:1px solid rgba(255,255,255,0.02);padding:10px 16px; display:flex; align-items:center; justify-content:space-between;}
    .brand { display:flex; gap:12px; align-items:center; }
    .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7dd3fc);display:grid;place-items:center;color:#00121a;font-weight:800;font-size:14px;}
    .site-title{ font-weight:700;color:var(--accent); font-size:1.05rem }
    .icon-btn{background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.03); padding:8px;border-radius:10px; cursor:pointer; display:inline-flex; gap:6px; align-items:center; justify-content:center;transition: transform .12s ease;}
    .icon-btn:hover{ transform: translateY(-3px); background: rgba(56,189,248,0.12); }
    .container{ max-width:1200px; margin:0 auto; padding:20px; }
    .payment-grid{ display:grid; grid-template-columns: 1fr 400px; gap:20px; margin-top:20px; }
    @media(max-width:900px){ .payment-grid{ grid-template-columns: 1fr; } }
    .card{background: var(--card-bg);border:1px solid var(--glass-border);border-radius:14px;padding:20px;box-shadow: 0 8px 20px rgba(0,0,0,0.28);backdrop-filter: blur(15px);}
    .step{padding:15px;border-radius:12px;border:1px solid var(--glass-border);background: var(--card-bg);margin-bottom:15px;}
    .step.active{border-color:var(--accent);background: rgba(56,189,248,0.08);}
    .step-title{font-weight:700;color:var(--accent);margin-bottom:8px;display:flex;align-items:center;gap:8px;}
    .btn{padding:12px 20px;border-radius:12px;border:none;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s;}
    .btn-primary{background:var(--accent);color:#00121a;}
    .btn-secondary{background:transparent;border:1px solid var(--glass-border);color:var(--accent);}
    .btn:hover{transform:translateY(-2px);}
    .input{width:100%;padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);color:#e8f6ff;margin-bottom:10px;}
    .address-box{background:rgba(255,255,255,0.05);border:1px solid var(--glass-border);border-radius:10px;padding:15px;margin:10px 0;word-break:break-all;font-family:monospace;}
    .qr-container{text-align:center;margin:20px 0;}
    .qr-code{width:200px;height:200px;border:2px solid var(--glass-border);border-radius:10px;margin:0 auto;display:flex;align-items:center;justify-content:center;background:white;}
    .amount-display{font-size:1.5rem;font-weight:800;color:var(--accent);text-align:center;margin:15px 0;}
    .network-badge{background:rgba(34,197,94,0.1);color:#22c55e;padding:6px 12px;border-radius:20px;font-size:0.9rem;display:inline-flex;align-items:center;gap:6px;}
    .warning{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);border-radius:10px;padding:15px;color:#ef4444;margin:15px 0;}
    .success{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:10px;padding:15px;color:#22c55e;margin:15px 0;}
    .timer{font-family:monospace;font-size:1.2rem;color:var(--warn);text-align:center;margin:10px 0;}
    .transaction-item{padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid var(--glass-border);margin-bottom:10px;}
    .status-pending{color:var(--warn);}
    .status-confirmed{color:var(--success);}
    .status-failed{color:var(--danger);}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:1000;}
    .modal-content{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:14px;padding:20px;max-width:400px;width:90%;}
    .notification{position:fixed;top:20px;right:20px;background:var(--card-bg);border:1px solid var(--glass-border);border-radius:10px;padding:15px;display:none;z-index:1001;}
    .header{position:fixed;top:0;left:0;right:0;z-index:1000;background:rgba(0,18,26,0.9);backdrop-filter:blur(15px);border-bottom:1px solid rgba(56,189,248,0.2);padding:8px 15px;}
    .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;min-height:50px;}
    .logo{display:flex;align-items:center;gap:8px;color:#38bdf8;font-weight:800;font-size:clamp(18px, 4vw, 24px);text-decoration:none;flex-shrink:0;}
    .header-actions{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    @media (max-width: 768px) {
      .header {padding: 6px 10px;}
      .header-content {min-height: 45px;}
      .logo {font-size: 16px;gap: 6px;}
      .header-actions {gap: 8px;}
    }
    @media (max-width: 480px) {
      .header {padding: 5px 8px;}
      .header-content {min-height: 40px;flex-wrap: nowrap;}
      .logo {font-size: 14px;gap: 4px;}
      .header-actions {gap: 6px;flex-shrink: 0;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo" style="width:54px;height:54px;border-radius:12px;background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);">
        <img src="https://i.postimg.cc/WzX8R9rC/mirac-removebg-preview.png" alt="MERAC Logo" style="height:26px;width:auto;">
      </div>
      <div>
        <div class="site-title" style="font-weight:800; color:var(--accent); letter-spacing:0.4px; font-size:1.05rem;">MERAC</div>
        <div style="font-size:0.85rem;color:var(--muted);">نظام الدفع USDT</div>
      </div>
    </div>
    <div>
      <button class="icon-btn" onclick="history.back()">
        <i data-lucide="arrow-right"></i>
      </button>
    </div>
  </div>

  <div class="container">
    <h1 style="color:var(--accent);margin-bottom:10px;">إيداع USDT (TRC20)</h1>
    <p style="color:var(--muted);">اختر طريقة الدفع المناسبة لك</p>

    <div class="payment-grid">
      <!-- Payment Methods -->
      <div>
        <!-- Step 1: Choose Payment Method -->
        <div class="step active" id="step1">
          <div class="step-title">
            <i data-lucide="wallet"></i>
            الخطوة 1: اختر طريقة الدفع
          </div>

          <button class="btn btn-primary" style="width:100%;margin-bottom:10px;" onclick="payWithTronLink()">
            <i data-lucide="link"></i>
            الدفع عبر TronLink (مباشر)
          </button>

          <button class="btn btn-secondary" style="width:100%;" onclick="showManualPayment()">
            <i data-lucide="qr-code"></i>
            الدفع اليدوي (QR + عنوان)
          </button>
        </div>

        <!-- Step 2: Manual Payment -->
        <div class="step" id="step2" style="display:none;">
          <div class="step-title">
            <i data-lucide="send"></i>
            الخطوة 2: إرسال USDT
          </div>

          <div class="network-badge">
            <i data-lucide="shield-check"></i>
            شبكة TRON (TRC20)
          </div>

          <div class="amount-display" id="paymentAmount">
            0 USDT
          </div>

          <div>
            <strong>عنوان الإيداع الخاص بك:</strong>
            <div class="address-box" id="depositAddress">
              جاري التحميل...
            </div>
            <button class="btn btn-secondary" onclick="copyAddress()">
              <i data-lucide="copy"></i>
              نسخ العنوان
            </button>
          </div>

          <div class="qr-container">
            <div class="qr-code" id="qrCode">
              <div style="color:#666;">QR Code</div>
            </div>
            <p style="color:var(--muted);font-size:0.9rem;">امسح الكود بمحفظتك</p>
          </div>

          <div class="warning">
            <i data-lucide="alert-triangle"></i>
            <strong>تحذير:</strong> أرسل فقط USDT على شبكة TRON (TRC20). الإرسال على شبكة أخرى سيؤدي لفقدان الأموال.
          </div>

          <div class="timer" id="countdown">
            الوقت المتبقي: 15:00
          </div>
        </div>

        <!-- Step 3: Waiting for Confirmation -->
        <div class="step" id="step3" style="display:none;">
          <div class="step-title">
            <i data-lucide="clock"></i>
            الخطوة 3: انتظار التأكيد
          </div>

          <div style="text-align:center;padding:20px;">
            <div style="font-size:3rem;color:var(--accent);margin-bottom:10px;">
              <i data-lucide="loader" class="rotating"></i>
            </div>
            <p>جاري مراقبة المعاملة...</p>
            <p style="color:var(--muted);font-size:0.9rem;">
              عادة ما يستغرق التأكيد من 1-5 دقائق
            </p>
          </div>
        </div>
      </div>

      <!-- Sidebar: Account Info & History -->
      <div>
        <!-- Account Balance -->
        <div class="card">
          <h3 style="color:var(--accent);margin-top:0;">رصيد الحساب</h3>
          <div style="font-size:1.5rem;color:var(--accent);margin:10px 0;" id="currentBalance">
            0 USDT
          </div>
          <div style="color:var(--muted);font-size:0.9rem;">
            المتاح: <span id="availableBalance">0 USDT</span>
          </div>
        </div>

        <!-- Payment Instructions -->
        <div class="card">
          <h3 style="color:var(--accent);margin-top:0;">تعليمات الدفع</h3>
          <ul style="color:var(--muted);padding-right:20px;">
            <li>أرسل فقط USDT على شبكة TRON (TRC20)</li>
            <li>أرسل المبلغ بالضبط كما هو محدد</li>
            <li>سيتم إضافة الرصيد تلقائياً بعد التأكيد</li>
            <li>الحد الأدنى للإيداع: 1 USDT</li>
          </ul>
        </div>

        <!-- Recent Transactions -->
        <div class="card">
          <h3 style="color:var(--accent);margin-top:0;">المعاملات الأخيرة</h3>
          <div id="transactionHistory">
            <p style="color:var(--muted);text-align:center;">لا توجد معاملات</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal" id="successModal">
    <div class="modal-content">
      <div style="text-align:center;">
        <div style="font-size:3rem;color:var(--success);margin-bottom:15px;">
          <i data-lucide="check-circle"></i>
        </div>
        <h3 style="color:var(--success);">تم تأكيد الإيداع!</h3>
        <p id="successMessage">تم إضافة الرصيد لحسابك</p>
        <button class="btn btn-primary" onclick="closeModal()">
          حسناً
        </button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <div id="notificationMessage"></div>
  </div>

  <script>
    let socket;
    let depositAddress = 'TR4Z3fYtTgGp5McMcyQrNgGjRL6jQESXBx';
    let currentUserId = '';
    let countdownTimer;
    let selectedPlan = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      lucide.createIcons();
      await initializePayment();
      setupSocketConnection();
      loadBalance();
      loadTransactionHistory();

      // Add rotation animation for loading icon
      const style = document.createElement('style');
      style.textContent = `
        .rotating {
          animation: rotate 2s linear infinite;
        }
        @keyframes rotate {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
    });

    // Initialize payment system
    async function initializePayment() {
      try {
        // Load plan data from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const planName = urlParams.get('plan');
        const amount = urlParams.get('amount');

        // Try to load from sessionStorage first
        const storedPlan = sessionStorage.getItem('selectedPlan');
        if (storedPlan) {
          selectedPlan = JSON.parse(storedPlan);
        } else if (planName && amount) {
          selectedPlan = { name: planName, investment: parseFloat(amount) };
        }

        // Update UI with plan data
        if (selectedPlan) {
          document.getElementById('paymentAmount').textContent = `${selectedPlan.investment} USDT`;
          updateSidebarInfo();
        }

        // Set deposit address
        document.getElementById('depositAddress').textContent = depositAddress;
        generateQRCode(depositAddress);

        // Try to get current user (optional for guest payments)
        try {
          const userResponse = await fetch('/api/current-user');
          if (userResponse.ok) {
            const userData = await userResponse.json();
            currentUserId = userData.id;
          }
        } catch (e) {
          console.log('User not logged in - guest payment allowed');
        }

      } catch (error) {
        console.error('Error initializing payment:', error);
        showNotification('خطأ في تهيئة نظام الدفع', 'error');
      }
    }

    // Setup Socket.IO connection
    function setupSocketConnection() {
      socket = io();

      socket.on('connect', () => {
        console.log('Connected to server');
        socket.emit('join', currentUserId);
      });

      socket.on('depositConfirmed', (data) => {
        showSuccessModal(`تم تأكيد إيداع ${data.amount} USDT`);
        loadBalance();
        loadTransactionHistory();
      });

      socket.on('withdrawalCompleted', (data) => {
        showNotification(`تم إتمام سحب ${data.amount} USDT`, 'success');
        loadBalance();
      });

      socket.on('withdrawalFailed', (data) => {
        showNotification('فشل في عملية السحب', 'error');
      });
    }

    // Pay with TronLink
    async function payWithTronLink() {
      if (typeof window.tronWeb === 'undefined') {
        showNotification('محفظة TronLink غير مثبتة. يرجى تثبيتها أولاً.', 'error');
        return;
      }

      try {
        let amount = selectedPlan ? selectedPlan.investment : null;

        if (!amount) {
          amount = prompt('أدخل المبلغ بـ USDT:');
          if (!amount || isNaN(amount) || amount <= 0) return;
        }

        showStep(3);

        // Get network info
        const networkResponse = await fetch('/api/networkInfo');
        const networkData = await networkResponse.json();

        // Send USDT using TronLink
        const contract = await window.tronWeb.contract().at(networkData.usdtContract);
        const amountSun = window.tronWeb.toBigNumber(amount).multipliedBy(1e6);

        const result = await contract.transfer(depositAddress, amountSun).send();

        if (result) {
          showNotification('تم إرسال المعاملة. جاري انتظار التأكيد...', 'success');
          // The deposit will be detected automatically by the monitoring system
        }
      } catch (error) {
        console.error('TronLink payment error:', error);
        showNotification('خطأ في الدفع عبر TronLink', 'error');
        showStep(1);
      }
    }

    // Update sidebar with plan information
    function updateSidebarInfo() {
      if (!selectedPlan) return;

      const balanceCard = document.querySelector('.card h3');
      if (balanceCard) {
        balanceCard.textContent = `خطة ${selectedPlan.name}`;
      }

      const currentBalance = document.getElementById('currentBalance');
      if (currentBalance) {
        currentBalance.textContent = `${selectedPlan.investment} USDT`;
        currentBalance.parentElement.querySelector('.text-muted')?.remove();

        const planInfo = document.createElement('div');
        planInfo.style.cssText = 'color:var(--muted);font-size:0.9rem;margin-top:8px;';
        planInfo.innerHTML = `خطة الاستثمار: ${selectedPlan.name}<br>المبلغ المطلوب: ${selectedPlan.investment} USDT`;
        currentBalance.parentElement.appendChild(planInfo);
      }
    }

    // Show manual payment
    function showManualPayment() {
      let amount = selectedPlan ? selectedPlan.investment : null;

      if (!amount) {
        amount = prompt('أدخل المبلغ بـ USDT:');
        if (!amount || isNaN(amount) || amount <= 0) return;
      }

      document.getElementById('paymentAmount').textContent = `${amount} USDT`;
      showStep(2);
      startCountdown(15 * 60); // 15 minutes
    }

    // Show specific step
    function showStep(stepNumber) {
      document.querySelectorAll('.step').forEach(step => {
        step.style.display = 'none';
        step.classList.remove('active');
      });

      const targetStep = document.getElementById(`step${stepNumber}`);
      if (targetStep) {
        targetStep.style.display = 'block';
        targetStep.classList.add('active');
      }
    }

    // Start countdown timer
    function startCountdown(seconds) {
      let timeLeft = seconds;
      const display = document.getElementById('countdown');

      countdownTimer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        display.textContent = `الوقت المتبقي: ${minutes}:${secs.toString().padStart(2, '0')}`;

        if (timeLeft <= 0) {
          clearInterval(countdownTimer);
          display.textContent = 'انتهت صلاحية الدفع';
          showStep(1);
        }
        timeLeft--;
      }, 1000);
    }

    // Generate QR Code
    function generateQRCode(address) {
      const qrContainer = document.getElementById('qrCode');
      qrContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(address)}" alt="QR Code" style="width:100%;height:100%;object-fit:contain;">`;
    }

    // Copy address to clipboard
    async function copyAddress() {
      try {
        await navigator.clipboard.writeText(depositAddress);
        showNotification('تم نسخ العنوان', 'success');
      } catch (error) {
        showNotification('فشل في النسخ', 'error');
      }
    }

    // Load user balance
    async function loadBalance() {
      try {
        const response = await fetch('/api/balance');
        const data = await response.json();

        if (data.success) {
          document.getElementById('currentBalance').textContent = `${data.balance} USDT`;
          document.getElementById('availableBalance').textContent = `${data.availableBalance} USDT`;
        }
      } catch (error) {
        console.error('Error loading balance:', error);
      }
    }

    // Load transaction history
    async function loadTransactionHistory() {
      try {
        const response = await fetch('/api/transactions');
        const data = await response.json();

        if (data.success) {
          const container = document.getElementById('transactionHistory');
          container.innerHTML = '';

          const allTransactions = [
            ...data.deposits.map(d => ({...d, type: 'deposit'})),
            ...data.withdrawals.map(w => ({...w, type: 'withdrawal'}))
          ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

          if (allTransactions.length === 0) {
            container.innerHTML = '<p style="color:var(--muted);text-align:center;">لا توجد معاملات</p>';
            return;
          }

          allTransactions.slice(0, 5).forEach(tx => {
            const item = document.createElement('div');
            item.className = 'transaction-item';

            const typeText = tx.type === 'deposit' ? 'إيداع' : 'سحب';
            const statusClass = `status-${tx.status}`;
            const statusText = {
              'pending': 'معلق',
              'confirmed': 'مؤكد',
              'completed': 'مكتمل',
              'failed': 'فشل'
            }[tx.status] || tx.status;

            item.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-weight:700;">${typeText} ${tx.amount} USDT</div>
                  <div style="color:var(--muted);font-size:0.9rem;">${new Date(tx.created_at).toLocaleString('ar')}</div>
                </div>
                <div class="${statusClass}">${statusText}</div>
              </div>
            `;
            container.appendChild(item);
          });
        }
      } catch (error) {
        console.error('Error loading transaction history:', error);
      }
    }

    // Show success modal
    function showSuccessModal(message) {
      document.getElementById('successMessage').textContent = message;
      document.getElementById('successModal').style.display = 'flex';
    }

    // Close modal
    function closeModal() {
      document.getElementById('successModal').style.display = 'none';
      showStep(1);
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      const messageEl = document.getElementById('notificationMessage');

      messageEl.textContent = message;
      notification.style.display = 'block';

      // Auto hide after 5 seconds
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>